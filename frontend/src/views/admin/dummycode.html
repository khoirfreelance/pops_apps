methods: {
    async loadChildren() {
      try {
        const res = await axios.get(`${baseURL}/api/children`, {
          headers: {
            Accept: 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
        })

        // API structure: { status, message, data_anak: [...] }
        const items = res.data.data_anak || []
        this.rawData = items
        //console.log(items);

         // ðŸ”¹ Filter langsung berdasarkan kelurahan user
        const filteredByKelurahan = items.filter(
          (item) =>
            item.kelurahan?.toLowerCase() === this.kelurahan?.toLowerCase()
        );

        this.children = filteredByKelurahan.map((item) => {
          const kelahiran = item.kelahiran?.[0] || {}
          const keluarga = item.keluarga?.[0] || {}
          const pendamping = item.pendampingan?.[item.pendampingan.length - 1] || {}
          const posyandu = item.posyandu?.[item.posyandu.length - 1] || {}
          const intervensi = item.intervensi?.[item.intervensi.length - 1] // ambil intervensi terakhir

          return {
            // === Identitas Anak ===
            id: item.id,
            nama: item.nama || '-',
            nik: item.nik || '-',
            gender: item.jk || '-',
            provinsi: item.provinsi || '-',
            kota: item.kota || '-',
            kecamatan: item.kecamatan || '-',
            kelurahan: item.kelurahan || '-',
            rt: item.rt || '-',
            rw: item.rw || '-',

            // === Data Posyandu terakhir ===
            posyandu: posyandu.posyandu || '-',
            usia: posyandu.usia || '-',
            tgl_ukur: posyandu.tgl_ukur || '-',
            bbu: posyandu.bbu || '-',
            tbu: posyandu.tbu || '-',
            bbtb: posyandu.bbtb || '-',
            bb: posyandu.bb || '-',
            tb: posyandu.tb || '-',
            bb_naik: posyandu.bb_naik || false,

            // === Data Intervensi ===
            intervensi: intervensi ? intervensi.jenis : 'Belum dapat Intervensi',

            // === Tambahan opsional ===
            tmpt_dilahirkan: kelahiran.tmpt_dilahirkan || '-',
            tgl_lahir: kelahiran.tgl_lahir || '-',
            bb_lahir: kelahiran.bb_lahir || '-',
            pb_lahir: kelahiran.pb_lahir || '-',
            persalinan: kelahiran.persalinan || '-',
            nama_ayah: keluarga.nama_ayah || '-',
            nama_ibu: keluarga.nama_ibu || '-',
            pekerjaan_ayah: keluarga.pekerjaan_ayah || '-',
            pekerjaan_ibu: keluarga.pekerjaan_ibu || '-',
            usia_ayah: keluarga.usia_ayah || '-',
            usia_ibu: keluarga.usia_ibu || '-',
            anak_ke: keluarga.anak_ke || '-',
            kader_pendamping: pendamping.kader || '-',
            tgl_pendampingan: pendamping.tanggal || '-',

            // === Simpan data mentah (buat showDetail nanti) ===
            raw: {
              kelahiran: item.kelahiran || [],
              keluarga: item.keluarga || [],
              pendampingan: item.pendampingan || [],
              posyandu: item.posyandu || [],
              intervensi: item.intervensi || []
            }
          }

        })

        // Setelah data dimuat, langsung apply filter awal
        this.applyFilter()

        // ðŸ”¹ Inisialisasi filteredData
        this.filteredData = [...this.children];

        // ðŸ”¹ Hitung total anak dengan usia < 60 bulan
        this.totalAnak = this.children.filter((anak) => anak.usia < 60).length;

        // ðŸ”¹ Hitung status gizi awal
        this.hitungStatusGizi();
        this.generateListsFromChildren()
      } catch (e) {
        console.error(e);

        //this.showError('Error Ambil Data Anak', e)
      }
    },
    async loadBride() {
      try {
        const res = await axios.get(`${baseURL}/api/bride`, {
          headers: {
            Accept: 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          }
        })

        this.bride = res.data.map(item => {
        const pendamping = item.catin?.pendampingan?.[0] || {} // ambil pendampingan pertama

        return {
          id: item.id,
          tgl_daftar: item.tgl_daftar,
          tgl_rencana_menikah: item.tgl_rencana_menikah,
          rencana_tinggal: item.rencana_tinggal,

          // --- Data Catin Perempuan ---
          nama_perempuan: item.catin?.nama || '',
          nik_perempuan: item.catin?.nik || '',
          pekerjaan_perempuan: item.catin?.pekerjaan || '',
          tgl_lahir_perempuan: item.catin?.tgl_lahir || '',
          usia_perempuan: item.catin?.usia || '',
          hp_perempuan: item.catin?.no_hp || '',

          // --- Data Catin Pria ---
          nama_pria: item.catin?.pasangan?.nama || '',
          nik_pria: item.catin?.pasangan?.nik || '',
          pekerjaan_pria: item.catin?.pasangan?.pekerjaan || '',
          tgl_lahir_pria: item.catin?.pasangan?.tgl_lahir || '',
          usia_pria: item.catin?.pasangan?.usia || '',
          hp_pria: item.catin?.pasangan?.no_hp || '',

          // --- Data Pendampingan ---
          tgl_pemeriksaan: pendamping.tgl_pemeriksaan || '',
          tgl_pendampingan: pendamping.tgl_pendampingan || '',
          dampingan_ke: pendamping.dampingan_ke || '',
          bb: pendamping.bb || '',
          tb: pendamping.tb || '',
          lila: pendamping.lila || '',
          hb: pendamping.hb || '',
          imt: pendamping.imt || '',
          status_hb: pendamping.anemia || '',
          status_gizi: pendamping.kek || '',
          catin_terpapar_rokok: pendamping.catin_terpapar_rokok || '',
          catin_ttd: pendamping.catin_ttd || '',
          punya_riwayat_penyakit: pendamping.punya_riwayat_penyakit || '',
          riwayat_penyakit: pendamping.riwayat_penyakit || '',
          fasilitas_rujukan: pendamping.fasilitas_rujukan || '',
          edukasi: pendamping.edukasi || '',
          pmt: pendamping.pmt || '',
          catatan: pendamping.catatan ?? ''
        }})

      } catch (e) {
        //console.error('Gagal ambil data:', e)
        this.showError('Error Ambil Data', e)
      }
    },
    async hitungStatusBumil() {
      try {
        const res = await axios.get(`${baseURL}/api/pregnancy/status`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        })
        const data = res.data
        //console.log('ðŸ“Š hitungStatusKesehatan ->', data)
        const total = data.total || 0

        this.kesehatan_bumil = data.counts.map(item => ({
          title: item.title,
          value: item.value,
          percent: total > 0 ? ((item.value / total) * 100).toFixed(1) + '%' : '0%',
          color: item.color,
        }))
        this.totalBumil = total

      } catch (e) {
        console.error('âŒ hitungStatusKesehatan error:', e)
      }
    },
    hitungIntervensi() {
      const data = this.filteredData || []
      if (!data.length) return { belum: 0, dapat: 0 }

      let belum = 0
      let sudah = 0

      data.forEach((anak) => {
        const intervensi = anak.raw?.intervensi || []
        // cek apakah punya intervensi valid
        const punyaIntervensi = intervensi.some((i) => i?.jenis && i.jenis !== 'Belum Mendapatkan Bantuan')

        if (punyaIntervensi) {
          sudah++
        } else {
          belum++
        }
      })

      return { belum, sudah }
    },
    generateInfoBoxes() {
      let intervensiKurang = 0
      let kasusBaru = 0
      let dataPending = 0
      let maxDiffBulan = 0

      const stuntingByDesa = {}
      const stuntingPerBulan = {} // ðŸŒŸ key: 'YYYY-MM', value: jumlah anak stunting
      const data = this.filteredData || []

      // ambil periode filter (format: 'YYYY-MM')
      const periodeFilter = this.filters?.periode
      const periodeDate = periodeFilter ? new Date(periodeFilter + '-01') : null

      data.forEach(child => {
        const posyandu = child.raw?.posyandu || []
        if (posyandu.length === 0) return

        // --- Hitung stunting per bulan per anak
        posyandu.forEach(p => {
          const d = new Date(p.tgl_ukur)
          const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`
          const isStunting = ['Stunted', 'Severely Stunted'].includes(p.tbu)
          if (isStunting) {
            stuntingPerBulan[ym] = (stuntingPerBulan[ym] || 0) + 1
            if (child.kelurahan) {
              stuntingByDesa[child.kelurahan] = (stuntingByDesa[child.kelurahan] || 0) + 1
            }
          }
        })

        // sort tanggal
        const sorted = [...posyandu].sort(
          (a, b) => new Date(a.tgl_ukur) - new Date(b.tgl_ukur)
        )

        // cari current (periode sekarang) & prev (bulan sebelumnya)
        let current = null
        let prev = null

        if (periodeDate) {
          // cari data di bulan sesuai filter
          const match = sorted.find(p => {
            const t = new Date(p.tgl_ukur)
            return (
              t.getFullYear() === periodeDate.getFullYear() &&
              t.getMonth() === periodeDate.getMonth()
            )
          })
          if (match) {
            const idx = sorted.indexOf(match)
            current = sorted[idx]
            prev = sorted[idx - 1] || null
          }
        } else {
          current = sorted[sorted.length - 1]
          prev = sorted[sorted.length - 2]
        }

        // --- Intervensi kurang
        const bermasalah =
          ['Underweight', 'Severely Underweight'].includes(current?.bbu) ||
          ['Stunted', 'Severely Stunted'].includes(current?.tbu) ||
          ['Wasted', 'Severely Wasted'].includes(current?.bbtb)

        const intervensi = child.raw?.intervensi || []
        const adaPMT =
          intervensi.some(i => i.jenis?.toUpperCase() === 'PMT') ||
          child.intervensi === 'PMT'

        if (bermasalah && !adaPMT) intervensiKurang++

        // --- Kasus baru
        if (
          prev &&
          !['Stunted', 'Severely Stunted'].includes(prev.tbu) &&
          ['Stunted', 'Severely Stunted'].includes(current?.tbu)
        ) kasusBaru++

        // --- Data pending
        if (current) {
          const refDate = periodeDate || new Date()
          const diffBulan =
            (refDate.getFullYear() - new Date(current.tgl_ukur).getFullYear()) * 12 +
            (refDate.getMonth() - new Date(current.tgl_ukur).getMonth())

          if (diffBulan > maxDiffBulan) maxDiffBulan = diffBulan
          if (diffBulan >= 2) dataPending++
        }
      })

      // --- ðŸš€ Hitung tren stunting per bulan
      const bulanSorted = Object.keys(stuntingPerBulan).sort()
      let stuntingNow = 0
      let stuntingPrev = 0

      if (periodeDate) {
        const ymNow = `${periodeDate.getFullYear()}-${String(periodeDate.getMonth() + 1).padStart(2, '0')}`
        const ymPrev = `${periodeDate.getFullYear()}-${String(periodeDate.getMonth()).padStart(2, '0')}`
        stuntingNow = stuntingPerBulan[ymNow] || 0
        stuntingPrev = stuntingPerBulan[ymPrev] || 0
      } else if (bulanSorted.length > 0) {
        const last = bulanSorted[bulanSorted.length - 1]
        const prev = bulanSorted[bulanSorted.length - 2]
        stuntingNow = stuntingPerBulan[last] || 0
        stuntingPrev = stuntingPerBulan[prev] || 0
      }

      const naik =
        stuntingPrev === 0 ? 0 : ((stuntingNow - stuntingPrev) / stuntingPrev) * 100

      // --- Desa dengan stunting tertinggi
      let desaTertinggi = this.kelurahan
      if (Object.keys(stuntingByDesa).length > 0) {
        desaTertinggi = Object.entries(stuntingByDesa).sort((a, b) => b[1] - a[1])[0][0]
      }

      function capitalizeWords(str) {
        return str.replace(/\b\w/g, c => c.toUpperCase())
      }

      const bulanTerakhir =
        maxDiffBulan > 1 ? `${maxDiffBulan} bulan terakhir` : 'bulan ini'

      this.infoBoxes = [
        {
          type: 'danger',
          title: `Stunting ${naik >= 0 ? 'naik' : 'turun'} ${Math.abs(naik).toFixed(1)}%`,
          desc: `Dibanding periode sebelumnya, tertinggi di Desa <strong>${capitalizeWords(
            desaTertinggi
          )}</strong>.`,
        },
        {
          type: 'warning',
          title: 'Intervensi',
          desc: `${intervensiKurang} anak bermasalah gizi belum mendapat bantuan.`,
        },
        {
          type: 'info',
          title: 'Kasus baru',
          desc: `${kasusBaru} kasus stunting baru terdeteksi pada periode ini.`,
        },
        {
          type: 'success',
          title: 'Data Pending',
          desc: `${dataPending} anak belum update data pengukuran ${bulanTerakhir}.`,
        },
      ]
    },
    async generateDataTableBumil() {
      try {
        const res = await axios.get(`${baseURL}/api/pregnancy/tren`, {
          headers: {
            Accept: 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
        });
        console.log('debug datatable bumil:', res.data);

        this.dataTable_bumil = res.data.dataTable_bumil || [];
      } catch (e) {
        this.showError('Error Ambil Data', e);
      }
    },
    generateDataTableBB() {
      const data = (this.filteredData?.length ? this.filteredData : this.children) || [];
      if (!data.length) return;

      const categories = [
        'Severely Underweight',
        'Underweight',
        'Normal',
        'Risiko BB Lebih',
      ];

      // hasil akhir: { '2025-08': { 'Normal': 12, 'Underweight': 5, ... }, ... }
      const perPeriode = {};

      // --- 1ï¸âƒ£ Kelompokkan data per bulan berdasarkan hasil BBU
      data.forEach(child => {
        const posyandu = child.raw?.posyandu || [];
        posyandu.forEach(p => {
          const t = new Date(p.tgl_ukur);
          const periode = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}`;
          const status = (p.bbu || 'Tidak diketahui').trim();
          if (!perPeriode[periode]) perPeriode[periode] = {};
          perPeriode[periode][status] = (perPeriode[periode][status] || 0) + 1;
        });
      });

      // --- 2ï¸âƒ£ Urutkan periode kronologis
      const periodeList = Object.keys(perPeriode).sort();

      // --- 3ï¸âƒ£ Tentukan periode aktif
      const periodeAktif = this.filters?.periode || periodeList.at(-1);
      const periodeSebelum = periodeList[periodeList.indexOf(periodeAktif) - 1] || null;

      // --- 4ï¸âƒ£ Hitung total anak per periode
      const totalNow = Object.values(perPeriode[periodeAktif] || {}).reduce((a, b) => a + b, 0);
      const totalPrev = Object.values(perPeriode[periodeSebelum] || {}).reduce((a, b) => a + b, 0);

      // --- 5ï¸âƒ£ Bangun tabel data kategori + tren antar-periode
      this.dataTable_bb = categories.map(status => {
        const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
        const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

        const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
        const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

        const delta = persenNow - persenPrev;
        const naik = delta >= 0;
        const trenClass = naik ? 'text-danger' : 'text-additional';
        const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

        return {
          status,
          jumlah: jumlahNow,
          persen: parseFloat(persenNow),
          tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
          trenClass,
          trenIcon,
        };
      });

      // --- 6ï¸âƒ£ Tambahkan kategori tambahan yang tidak ada di daftar utama
      const allStatuses = new Set(Object.keys(perPeriode[periodeAktif] || {}));
      allStatuses.forEach(status => {
        if (!categories.includes(status)) {
          const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
          const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

          const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
          const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

          const delta = persenNow - persenPrev;
          const naik = delta >= 0;
          const trenClass = naik ? 'text-danger' : 'text-additional';
          const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

          this.dataTable_bb.push({
            status,
            jumlah: jumlahNow,
            persen: parseFloat(persenNow),
            tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
            trenClass,
            trenIcon,
          });
        }
      });
    },
    generateDataTableTB() {
      const data = (this.filteredData?.length ? this.filteredData : this.children) || [];
      if (!data.length) return;

      const categories = ['Severely Stunted', 'Stunted', 'Normal', 'Tinggi'];
      const perPeriode = {};

      // --- 1ï¸âƒ£ kelompokkan per-periode berdasarkan TB/U (tbu)
      data.forEach(child => {
        const posyandu = child.raw?.posyandu || [];
        posyandu.forEach(p => {
          const t = new Date(p.tgl_ukur);
          const periode = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}`;
          const status = (p.tbu || 'Tidak diketahui').trim();
          if (!perPeriode[periode]) perPeriode[periode] = {};
          perPeriode[periode][status] = (perPeriode[periode][status] || 0) + 1;
        });
      });

      const periodeList = Object.keys(perPeriode).sort();
      const periodeAktif = this.filters?.periode || periodeList.at(-1);
      const periodeSebelum = periodeList[periodeList.indexOf(periodeAktif) - 1] || null;

      const totalNow = Object.values(perPeriode[periodeAktif] || {}).reduce((a, b) => a + b, 0);
      const totalPrev = Object.values(perPeriode[periodeSebelum] || {}).reduce((a, b) => a + b, 0);

      this.dataTable_tb = categories.map(status => {
        const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
        const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

        const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
        const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

        const delta = persenNow - persenPrev;
        const naik = delta >= 0;
        const trenClass = naik ? 'text-danger' : 'text-additional';
        const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

        return {
          status,
          jumlah: jumlahNow,
          persen: parseFloat(persenNow),
          tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
          trenClass,
          trenIcon,
        };
      });

      // --- kategori tambahan di luar daftar utama
      const allStatuses = new Set(Object.keys(perPeriode[periodeAktif] || {}));
      allStatuses.forEach(status => {
        if (!categories.includes(status)) {
          const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
          const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

          const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
          const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

          const delta = persenNow - persenPrev;
          const naik = delta >= 0;
          const trenClass = naik ? 'text-danger' : 'text-additional';
          const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

          this.dataTable_tb.push({
            status,
            jumlah: jumlahNow,
            persen: parseFloat(persenNow),
            tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
            trenClass,
            trenIcon,
          });
        }
      });
    },
    generateDataTableStatus() {
      const data = (this.filteredData?.length ? this.filteredData : this.children) || [];
      if (!data.length) return;

      const categories = [
        'Severely Wasted',
        'Wasted',
        'Normal',
        'Possible risk of Overweight',
        'Overweight',
        'Obesitas',
      ];
      const perPeriode = {};

      // --- 1ï¸âƒ£ kelompokkan per-periode berdasarkan BB/TB (bbtb)
      data.forEach(child => {
        const posyandu = child.raw?.posyandu || [];
        posyandu.forEach(p => {
          const t = new Date(p.tgl_ukur);
          const periode = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}`;
          const status = (p.bbtb || 'Tidak diketahui').trim();
          if (!perPeriode[periode]) perPeriode[periode] = {};
          perPeriode[periode][status] = (perPeriode[periode][status] || 0) + 1;
        });
      });

      const periodeList = Object.keys(perPeriode).sort();
      const periodeAktif = this.filters?.periode || periodeList.at(-1);
      const periodeSebelum = periodeList[periodeList.indexOf(periodeAktif) - 1] || null;

      const totalNow = Object.values(perPeriode[periodeAktif] || {}).reduce((a, b) => a + b, 0);
      const totalPrev = Object.values(perPeriode[periodeSebelum] || {}).reduce((a, b) => a + b, 0);

      this.dataTable_status = categories.map(status => {
        const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
        const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

        const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
        const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

        const delta = persenNow - persenPrev;
        const naik = delta >= 0;
        const trenClass = naik ? 'text-danger' : 'text-additional';
        const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

        return {
          status,
          jumlah: jumlahNow,
          persen: parseFloat(persenNow),
          tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
          trenClass,
          trenIcon,
        };
      });

      // --- kategori tambahan di luar daftar utama
      const allStatuses = new Set(Object.keys(perPeriode[periodeAktif] || {}));
      allStatuses.forEach(status => {
        if (!categories.includes(status)) {
          const jumlahNow = (perPeriode[periodeAktif]?.[status]) || 0;
          const jumlahPrev = (perPeriode[periodeSebelum]?.[status]) || 0;

          const persenNow = totalNow ? ((jumlahNow / totalNow) * 100).toFixed(2) : 0;
          const persenPrev = totalPrev ? ((jumlahPrev / totalPrev) * 100).toFixed(2) : 0;

          const delta = persenNow - persenPrev;
          const naik = delta >= 0;
          const trenClass = naik ? 'text-danger' : 'text-additional';
          const trenIcon = naik ? 'bi bi-caret-up-fill' : 'bi bi-caret-down-fill';

          this.dataTable_status.push({
            status,
            jumlah: jumlahNow,
            persen: parseFloat(persenNow),
            tren: `${naik ? '+' : ''}${delta.toFixed(1)}%`,
            trenClass,
            trenIcon,
          });
        }
      });
    },
    hitungStatusGizi() {
      // ðŸ”¹ Ambil data anak yang sudah difilter
      const dataAnak = this.filteredData.length ? this.filteredData : this.children;
      const f = this.filters;

      // ðŸ”¹ Bikin range periode (jika difilter)
      const [y, m] = f.periode ? f.periode.split('-') : [];
      const periodeNum = f.periode ? parseInt(y) * 100 + parseInt(m) : null;

      const count = {
        Stunting: 0,
        Wasting: 0,
        Underweight: 0,
        Normal: 0,
        'BB Stagnan': 0,
        Overweight: 0,
      };

      let total = 0;

      dataAnak.forEach((anak) => {
        const riwayat = anak.raw?.posyandu || [];
        if (!riwayat.length) return;

        // ðŸ”¹ Filter riwayat berdasarkan periode (jika difilter)
        const filteredRiwayat = periodeNum
          ? riwayat.filter((r) => {
              if (!r.tgl_ukur) return false;
              const tgl = new Date(r.tgl_ukur);
              const itemPeriode = tgl.getFullYear() * 100 + (tgl.getMonth() + 1);
              return itemPeriode === periodeNum;
            })
          : riwayat;

        // ðŸ”¹ Ambil data terakhir di periode itu
        const latest = filteredRiwayat[filteredRiwayat.length - 1];
        if (!latest) return;

        total++;

        // eslint-disable-next-line no-unused-vars
        const { bbu, tbu, bbtb, bb } = latest;

        if (tbu?.includes('Stunted')) count.Stunting++;
        if (bbtb?.includes('Wasted')) count.Wasting++;
        if (bbu?.includes('Underweight')) count.Underweight++;
        if (bbu === 'Normal' && tbu === 'Normal' && bbtb === 'Normal') count.Normal++;
        if (bbtb?.includes('Overweight')) count.Overweight++;

        // ðŸ”¹ Cek stagnan (3 kali BB terakhir sama â€” dari seluruh riwayat anak)
        if (riwayat.length >= 3) {
          const last3 = riwayat.slice(-3);
          const allEqual = last3.every((r) => r.bb === last3[0].bb);
          if (allEqual) count['BB Stagnan']++;
        }
      });

      // ðŸ”¹ Buat array untuk ditampilkan di ringkasan
      this.gizi = Object.entries(count).map(([title, value]) => {
        const percent = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
        const colorMap = {
          Stunting: 'danger',
          Wasting: 'warning',
          Underweight: 'violet',
          Normal: 'success',
          'BB Stagnan': 'info',
          Overweight: 'dark',
        };
        return { title, value, percent, color: colorMap[title] };
      });

      this.totalAnak = total;
    },
    hitungStatusCatin() {
      const dataCatin = this.filteredData.length ? this.filteredData : this.bride;
      console.log('Data Flatten:', dataCatin)
      const f = this.filters;

      const [y, m] = f.periode ? f.periode.split('-') : [];
      const periodeNum = f.periode ? parseInt(y) * 100 + parseInt(m) : null;

      const count = {
        KEK: 0,
        Anemia: 0,
      };
      let total = 0;

      dataCatin.forEach((ctn) => {
        const riwayat = ctn.raw?.pemeriksaan || [];
        if (!riwayat.length) return;

        const filtered = periodeNum
          ? riwayat.filter((r) => {
              if (!r.tgl_periksa) return false;
              const tgl = new Date(r.tgl_periksa);
              const periode = tgl.getFullYear() * 100 + (tgl.getMonth() + 1);
              return periode === periodeNum;
            })
          : riwayat;

        const latest = filtered[filtered.length - 1];
        if (!latest) return;

        total++;
        if (latest.kek) count.KEK++;
        if (latest.anemia) count.Anemia++;
      });

      this.gizi = Object.entries(count).map(([title, value]) => {
        const percent = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
        return { title, value, percent };
      });
      this.totalCatin = total;
    },
   renderRingkasan(periodeBulan = 3) {
      const n = parseInt(periodeBulan) || 3

      // Kirim filter ke semua chart
      this.renderLineChart(n)
      this.renderBarChart(n)
      this.renderFunnelChart(n)
      this.renderSudahChart(n)
    },
    renderLineChart(periodeBulan = 3) {
      const data = this.filteredData || []
      if (!data.length) return

      const now = new Date()
      const startDate = new Date()
      startDate.setMonth(now.getMonth() - periodeBulan + 1) // +1 biar include bulan sekarang

      // ðŸ”¸ Filter hanya anak tanpa intervensi (null atau 0)
      const tanpaIntervensi = data.filter(a => a.intervensi == null || a.intervensi == 0)

      // Flatten semua data posyandu dari anak tanpa intervensi
      const allPosyandu = tanpaIntervensi.flatMap((anak) =>
        (anak.raw?.posyandu || []).map((p) => ({
          tanggal: new Date(p.tgl_ukur),
          bb_naik: p.bb_naik,
        }))
      )

      // Filter hanya data dalam periode
      const recent = allPosyandu.filter(
        (p) => p.tanggal >= startDate && p.tanggal <= now
      )

      const monthNames = [
        'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun',
        'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'
      ]

      // Siapkan struktur bulan
      const monthlyData = {}
      for (let i = 0; i < periodeBulan; i++) {
        const temp = new Date(startDate)
        temp.setMonth(startDate.getMonth() + i)
        const key = `${temp.getFullYear()}-${String(temp.getMonth() + 1).padStart(2, '0')}`
        monthlyData[key] = { total: 0, tidakMembaik: 0 }
      }

      // Isi data sesuai bulan
      recent.forEach((p) => {
        const key = `${p.tanggal.getFullYear()}-${String(p.tanggal.getMonth() + 1).padStart(2, '0')}`
        if (monthlyData[key]) {
          monthlyData[key].total++
          if (!p.bb_naik) monthlyData[key].tidakMembaik++
        }
      })

      const sortedKeys = Object.keys(monthlyData).sort()
      const labels = sortedKeys.map((key) => {
        const [, month] = key.split('-')
        return monthNames[parseInt(month) - 1]
      })
      const dataTidakMembaik = sortedKeys.map((key) => monthlyData[key].tidakMembaik)

      // Hapus chart lama
      if (this.lineChart) this.lineChart.destroy()

      // Render Chart.js
      const ctx = this.$refs.lineChart.getContext('2d')
      this.lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Jumlah Anak Tidak Membaik (Tanpa Intervensi)',
              data: dataTidakMembaik,
              borderColor: 'goldenrod',
              backgroundColor: 'rgba(255, 215, 0, 0.3)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: 'goldenrod',
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y} anak tidak membaik`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 },
            },
          },
        },
      })
    },
    renderBarChart(periodeBulan = 3) {
      const data = this.filteredData || []
      if (!data.length) return

      // ðŸ”¹ Tentukan rentang waktu (default 3 bulan terakhir)
      const now = new Date()
      const startDate = new Date()
      startDate.setMonth(now.getMonth() - periodeBulan)

      // ðŸ”¹ Ambil semua entri posyandu dari setiap anak
      const allPosyandu = data.flatMap((anak) =>
        (anak.raw?.posyandu || []).map((p) => ({
          posyandu: p.posyandu || 'Tidak Diketahui',
          tanggal: new Date(p.tgl_ukur),
          bb_naik: p.bb_naik,
        }))
      )

      // ðŸ”¹ Ambil daftar unik semua posyandu (agar yang 0 juga muncul)
      const allPosyanduNames = [
        ...new Set(allPosyandu.map((p) => p.posyandu || 'Tidak Diketahui')),
      ]

      // ðŸ”¹ Filter hanya data dalam periode waktu
      const recent = allPosyandu.filter(
        (p) => p.tanggal >= startDate && p.tanggal <= now
      )

      // ðŸ”¹ Kelompokkan berdasarkan nama posyandu
      const posyanduCounts = {}
      allPosyanduNames.forEach((name) => (posyanduCounts[name] = 0)) // inisialisasi 0

      recent.forEach((p) => {
        const key = p.posyandu || 'Tidak Diketahui'
        if (!p.bb_naik) posyanduCounts[key]++
      })

      // ðŸ”¹ Siapkan data untuk Chart.js
      const labels = Object.keys(posyanduCounts)
      const values = Object.values(posyanduCounts)

      // ðŸ”¹ Hancurkan chart lama kalau ada
      if (this.barChart) this.barChart.destroy()

      // ðŸ”¹ Render chart baru
      const ctx = this.$refs.barChart.getContext('2d')
      this.barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Anak Tidak Membaik',
              data: values,
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderRadius: 8,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: false,
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y} anak tidak membaik`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Jumlah Anak',
              },
            },
            x: {
              title: {
                display: true,
                text: 'Posyandu',
              },
            },
          },
        },
      })
    },
    renderFunnelChart(periodeBulan = 3) {
      this.$nextTick(() => {
        const canvas = this.$refs.funnelChart
        if (!canvas) return // belum dirender

        const ctx = canvas.getContext('2d')
        const data = this.filteredData || []
        if (!data.length) return

        const now = new Date()
        const startDate = new Date()
        startDate.setMonth(now.getMonth() - periodeBulan)

        // ðŸ”¹ Flatten semua intervensi dari semua anak
        const allIntervensi = data.flatMap(anak =>
          (anak.raw?.intervensi || []).map(i => ({
            tanggal: new Date(i.tanggal),
            jenis: i.jenis && i.jenis.trim() !== "" ? i.jenis : "Belum Mendapatkan Bantuan"
          }))
        )

        // ðŸ”¹ Filter intervensi dalam periode
        const recentIntervensi = allIntervensi.filter(
          i => i.tanggal >= startDate && i.tanggal <= now
        )

        // ðŸ”¹ Daftar jenis tetap (supaya tampil meski 0)
        const jenisList = ['MBG', 'KIE', 'Bansos', 'PMT', 'Bantuan Lainnya', 'Belum Mendapatkan Bantuan']
        const counts = jenisList.map(jenis =>
          recentIntervensi.filter(i => i.jenis === jenis).length
        )

        // ðŸ”¹ Hapus chart lama
        if (this.funnelChart) this.funnelChart.destroy()

        // ðŸ”¹ Render Chart.js horizontal bar
        this.funnelChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: jenisList,
            datasets: [
              {
                data: counts,
                backgroundColor: [
                  '#006341',
                  '#007d52',
                  '#009562',
                  '#6fa287',
                  '#6d8b7b',
                  '#ea7f7f'
                ],
                color: '#FFFFFF'
              }
            ]
          },
          options: {
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              datalabels: {
                color: '#FFFFFF',
                anchor: 'center',
                align: 'center',
                font: { weight: 'bold' },
                formatter: value => value || '0'
              },
              title: { display: false }
            },
            scales: { x: { beginAtZero: true } }
          }
        })
      })
    },
    renderSudahChart(periodeBulan = 3) {
      this.$nextTick(() => {
        const canvas = this.$refs.sudahChart
        if (!canvas) return

        const ctx = canvas.getContext('2d')
        const data = this.filteredData || []
        if (!data.length) return

        const now = new Date()
        const startDate = new Date()
        startDate.setMonth(now.getMonth() - periodeBulan)

        // ðŸ”¹ Flatten intervensi valid (jenis tidak null/0/kosong)
        const allIntervensi = data.flatMap(anak =>
          (anak.raw?.intervensi || [])
            .filter(i => i && i.jenis && i.jenis !== "0" && i.jenis.trim() !== "")
            .map(i => ({
              tanggal: new Date(i.tanggal),
              jenis: i.jenis
            }))
        )

        // ðŸ”¹ Filter dalam periode
        const recentIntervensi = allIntervensi.filter(
          i => i.tanggal >= startDate && i.tanggal <= now
        )

        // ðŸ”¹ Pakai daftar tetap supaya muncul meski kosong
        const jenisList = ['MBG', 'KIE', 'Bansos', 'PMT', 'Bantuan Lainnya']
        const counts = jenisList.map(jenis =>
          recentIntervensi.filter(i => i.jenis === jenis).length
        )

        // ðŸ”¹ Hapus chart lama
        if (this.sudahChart) this.sudahChart.destroy()

        // ðŸ”¹ Render chart
        this.sudahChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: jenisList,
            datasets: [
              {
                data: counts,
                backgroundColor: [
                  '#006341',
                  '#007d52',
                  '#009562',
                  '#6fa287',
                  '#6d8b7b'
                ],
                color: '#FFFFFF'
              }
            ]
          },
          options: {
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              datalabels: {
                color: '#FFFFFF',
                anchor: 'center',
                align: 'center',
                font: { weight: 'bold' },
                formatter: value => value || '0'
              },
              title: { display: false }
            },
            scales: { x: { beginAtZero: true } }
          }
        })
      })
    },
    handlePosyanduChange() {
      const pos = this.filters.posyandu;
      if (!pos) {
        this.rwList = [];
        this.rtList = [];
        this.rwReadonly = true;
        this.rtReadonly = true;
        return;
      }

      const filteredChildren = this.children.filter(c => c.posyandu === pos);

      // Ambil nama_rw & nama_rt dari object
      const rwSet = new Set(
        filteredChildren
          .map(c => {
            if (typeof c.rw === 'object') return c.rw.nama_rw;
            if (typeof c.nama_rw !== 'undefined') return c.nama_rw;
            return c.rw;
          })
          .filter(Boolean)
      );

      const rtSet = new Set(
        filteredChildren
          .map(c => {
            if (typeof c.rt === 'object') return c.rt.nama_rt;
            if (typeof c.nama_rt !== 'undefined') return c.nama_rt;
            return c.rt;
          })
          .filter(Boolean)
      );

      this.rwList = Array.from(rwSet);
      this.rtList = Array.from(rtSet);
      this.rwReadonly = false;
      this.rtReadonly = false;
    },
    handleRwChange() {
      const pos = this.filters.posyandu;
      const rw = this.filters.rw;

      if (!rw) {
        this.rtList = [];
        this.rtReadonly = true;
        return;
      }

      const filteredChildren = this.children.filter(c => {
        const rwVal =
          typeof c.rw === 'object' ? c.rw.nama_rw :
          c.nama_rw ?? c.rw;
        return c.posyandu === pos && rwVal === rw;
      });

      const rtSet = new Set(
        filteredChildren
          .map(c => {
            if (typeof c.rt === 'object') return c.rt.nama_rt;
            if (typeof c.nama_rt !== 'undefined') return c.nama_rt;
            return c.rt;
          })
          .filter(Boolean)
      );

      this.rtList = Array.from(rtSet);
      this.rtReadonly = false;
    },
    generatePeriodeOptions() {
      const bulan = [
        'Januari', 'Februari', 'Maret', 'April',
        'Mei', 'Juni', 'Juli', 'Agustus',
        'September', 'Oktober', 'November', 'Desember'
      ]

      const now = new Date()
      const result = []

      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1)
        const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` // âœ… pakai tanda "-"
        const label = `${bulan[d.getMonth()]} ${d.getFullYear()}`
        result.push({ label, value })
      }

      this.periodeOptions = result
      //console.log('Periode options:', this.periodeOptions)

    },
    applyFilter() {
      const f = this.filters;
      this.rtReadonly = true
      this.rwReadonly = true
      // ðŸ”¹ Tentukan dataset sesuai tipe menu
      let sourceData = [];
      if (this.tipeMenu === 'anak') sourceData = this.children;
      else if (this.tipeMenu === 'bumil') sourceData = this.bumil;
      else if (this.tipeMenu === 'catin') sourceData = this.bride;

      // ðŸ”¹ Filter utama (Posyandu, RW, RT, Periode)
      this.filteredData = sourceData.filter(item => {
        // Posyandu
        const posyanduMatch = !f.posyandu || item.posyandu === f.posyandu || item.nama_posyandu === f.posyandu;
        // RW & RT
        const rwMatch = !f.rw || item.rw === f.rw;
        const rtMatch = !f.rt || item.rt === f.rt;

        // Periode
        const periodeMatch = (() => {
          if (!f.periode) return true;

          const [y, m] = f.periode.split('-');
          const periodeNum = parseInt(y) * 100 + parseInt(m);

          // tanggal acuannya tergantung tipe data
          const tanggalKey =
            this.tipeMenu === 'anak' ? 'tgl_ukur' : 'tgl_pendampingan';
          if (!item[tanggalKey]) return false;

          const [year, month, day] = item[tanggalKey].split('-').map(Number);
          const tgl = new Date(year, month - 1, day);
          const itemPeriode = tgl.getFullYear() * 100 + (tgl.getMonth() + 1);
          return itemPeriode === periodeNum;
        })();

        return posyanduMatch && rwMatch && rtMatch && periodeMatch;
      });

      // ðŸ”¹ Jalankan logika sesuai tipe menu
      if (this.tipeMenu === 'anak') {
        this.totalAnak = this.filteredData.filter(a => a.usia < 60).length;
        this.hitungStatusGizi();
        this.generateDataTableBB();
        this.generateDataTableTB();
        this.generateDataTableStatus();
        this.generateInfoBoxes();
        this.generateListsFromChildren();
        // render grafik khusus anak
        this.renderChart('pieChart_bb', this.dataTable_bb, [
          '#f5ebb9', '#f7db7f', '#7dae9b', '#bfbbe4', '#e87d7b',
        ]);
        this.renderChart('pieChart_tb', this.dataTable_tb, [
          '#f7db7f', '#bfbbe4', '#7dae9b', '#e87d7b',
        ]);
        this.renderChart('pieChart_status', this.dataTable_status, [
          '#f5ebb9', '#f7db7f', '#7dae9b', '#bfbbe4', '#e87d7b', '#eaafdd',
        ]);
      } else if (this.tipeMenu === 'bumil') {
        this.hitungStatusBumil();
        this.generateListsFromBumil?.(); // optional kalau ada
        this.renderChart('pieChart_status', this.gizi, [
          '#f5ebb9', '#f7db7f', '#7dae9b', '#bfbbe4',
        ]);
      } else if (this.tipeMenu === 'catin') {
        this.hitungStatusCatin();
        this.generateListsFromCatin?.(); // optional
        this.renderChart('pieChart_status', this.gizi, [
          '#f5ebb9', '#f7db7f', '#7dae9b',
        ]);
      }
    },
    renderChart(refName, dataTable, colors, labelKey = 'status', valueKey = 'persen') {
      const ctx = this.$refs[refName]?.getContext('2d');
      if (!ctx) return;

      // Hancurkan chart lama kalau ada
      if (this[refName + 'Instance']) {
        this[refName + 'Instance'].destroy();
      }

      if (!Array.isArray(dataTable) || !dataTable.length) {
        console.warn(`âš ï¸ Tidak ada data untuk chart ${refName}`);
        return;
      }

      const labels = dataTable.map(row => row[labelKey]);
      const values = dataTable.map(row => parseFloat(row[valueKey]) || 0);

      // Solid colors langsung dari array colors
      const solidColors = colors;

      this[refName + 'Instance'] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [
            {
              data: values,
              backgroundColor: solidColors,
              borderWidth: 0, // âœ… tanpa border putih
              hoverOffset: 12,
            },
          ],
        },
        options: {
          responsive: true,
          layout: { padding: 25 },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  return value > 0 ? [`${label}`, `${value}%`] : [];
                },
              },
            },
            datalabels: {
            display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
            color: 'rgb(0, 0, 0)',      // solid hitam
            font: {
              size: 11,
              weight: 'bold',
              opacity: 1,               // pastikan tidak transparan
            },
            backgroundColor: 'rgba(255,255,255,0)', // transparan di belakang teks
            align: 'center',
            anchor: 'center',
            clamp: true,
            offset: 0,
            formatter: (value, ctx) => {
              const label = ctx.chart.data.labels[ctx.dataIndex];
              return [label, `${value}%`];
            },
          },
          },
          onHover: (event, elements) => {
            event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
          },
          onClick: (event, elements) => {
            if (!elements.length) return;
            const index = elements[0].index;
            const item = dataTable[index];
            const status = item.status;

            let tipe = '';
            if (refName === 'pieChart_bb') tipe = 'BB/U';
            else if (refName === 'pieChart_tb') tipe = 'TB/U';
            else if (refName === 'pieChart_status') tipe = 'BB/TB';

            this.selectedChartStatus = status;
            this.selectedChartType = tipe;

            this.$router.push({
              path: '/admin/anak',
              query: { tipe, status },
            });
          },
        },
        plugins: [ChartDataLabels],
      });
    },
    loadIntervensiBumil() {
      // Pastikan data aman
      const data = this.dataTable_bumil || []

      const summary = {
        KEK: { sudah: 0, belum: 0 },
        Anemia: { sudah: 0, belum: 0 },
        'Risiko Tinggi': { sudah: 0, belum: 0 },
      }

      data.forEach((ibu) => {
        // --- KEK ---
        if (ibu.kek === 'Ya') {
          if (ibu.kek_intervensi === 'Ya') summary.KEK.sudah++
          else summary.KEK.belum++
        }

        // --- ANEMIA ---
        if (ibu.anemia === 'Ya') {
          if (ibu.anemia_intervensi === 'Ya') summary.Anemia.sudah++
          else summary.Anemia.belum++
        }

        // --- RISIKO TINGGI ---
        if (ibu.risti === 'Ya') {
          if (ibu.risti_intervensi === 'Ya') summary['Risiko Tinggi'].sudah++
          else summary['Risiko Tinggi'].belum++
        }
      })

      return summary
    },

    renderBumilChart() {
      const ctx = this.$refs.bumilChart?.getContext('2d')
      if (!ctx) return
      if (this.bumilChart) this.bumilChart.destroy()

      const summary = this.loadIntervensiBumil()
      const labels = Object.keys(summary)
      const sudah = labels.map((key) => summary[key].sudah)
      const belum = labels.map((key) => summary[key].belum)

      this.bumilChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Sudah Dapat Intervensi',
              data: sudah,
              backgroundColor: '#1B5E20',
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Belum Dapat Intervensi',
              data: belum,
              backgroundColor: '#C62828',
              borderRadius: 8,
              borderSkipped: false,
            },
          ],
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              stacked: true,
              beginAtZero: true,
              ticks: { precision: 0 },
            },
            y: { stacked: true },
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 14, padding: 16 },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x}`,
              },
            },
            title: {
              display: true,
              text: 'Diagram Intervensi Ibu Hamil',
              color: '#1B5E20',
              font: { size: 14, weight: 'bold' },
            },
          },
        },
      })
    },
  },